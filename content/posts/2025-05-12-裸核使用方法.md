---
title: 'è£¸æ ¸ä½¿ç”¨æ–¹æ³•'
date: 2025-05-12T21:22:42+08:00
draft: true
slug: 5ae84b1
description: Windows è£¸æ ¸ä½¿ç”¨æ–¹æ³•ã€‚
summary: Windows è£¸æ ¸ä½¿ç”¨æ–¹æ³•ã€‚
tags:
  - Windows
categories:
  - å®ç”¨æ•™ç¨‹
cover:
---

## å‰è¨€

æœ€è¿‘ä¸€äº› GUI å®¢æˆ·ç«¯å‡ºç°äº†ä¸€äº›æ¼æ´ï¼Œå¹¶ä¸”æ—¶ä¸æ—¶æœ‰ä¸€äº› BUGï¼Œè€Œå…¶ä»–å·¥å…·æ— æ³•å¾ˆå¥½åœ°åˆ†æµï¼Œæ‰€ä»¥å†³å®šä½¿ç”¨è£¸æ ¸ï¼Œåœ¨[ä¸€ç¯‡åšå®¢](https://senzyo.net/2023-7/)æ‰¾åˆ°äº†æ–¹æ³•ï¼Œå¯¹å…¶è„šæœ¬å°±è¡Œäº†ä¸€äº›ä¿®æ”¹ã€‚

## æ­¥éª¤

### æ ¸å¿ƒä¸‹è½½

ç›´æ¥ä¸‹è½½äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè§£å‹åæ— éœ€é‡å‘½åï¼Œæ–°å»ºä¸€ä¸ªæ–‡ä»¶å¤¹æ”¾å…¥ã€‚

### é…ç½®æ–‡ä»¶

åˆ›å»ºä¸€ä¸ª `config.yaml` æ–‡ä»¶ï¼Œå†™å…¥é…ç½®æ–‡ä»¶ï¼Œæ”¾å…¥æ ¸å¿ƒåŒçº§ç›®å½•ä¸‹ã€‚å‚è€ƒé…ç½®å¦‚ä¸‹ï¼Œæ›´æ¢è®¢é˜…é“¾æ¥(ç¬¬ 3 è¡Œ)ä»¥åŠå¤–éƒ¨ `API` æ§åˆ¶å¯†é’¥(ç¬¬ 50 è¡Œ)ã€‚

```yaml
proxy-providers: 
  ZJ:
    url: 'è®¢é˜…é“¾æ¥'
    path: './proxy-providers/ZJ.yaml'
    type: http
    interval: 86400
    health-check: 
      enable: true
      lazy: true
      url: http://latency-test.skk.moe/endpoint
      interval: 60



port: 7891
socks-port: 7892
mixed-port: 7890

redir-port: 7893
tproxy-port: 7894

unified-delay: true
tcp-concurrent: true
allow-lan: true
mode: rule
log-level: info
ipv6: true
udp: true

profile:
  store-selected: true
  store-fake-ip: true

find-process-mode: strict
global-client-fingerprint: chrome

geodata-mode: true
geodata-loader: standard
geo-auto-update: true
geo-update-interval: 24
geox-url:
  geoip: https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/geoip-lite.dat
  geosite: https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/geosite.dat
  mmdb: https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/country-lite.mmdb
  asn: https://github.com/xishang0128/geoip/releases/download/latest/GeoLite2-ASN.mmdb



external-controller: 127.0.0.1:9090
secret: "è‡ªå·±è®¾å®šä¸€ä¸ªå¯†ç "

external-ui: ui
external-ui-name: zashboard
external-ui-url: https://github.com/Zephyruso/zashboard/releases/latest/download/dist.zip
# external-ui-name: MetaCubeXD
# external-ui-url: https://github.com/MetaCubeX/metacubexd/archive/refs/heads/gh-pages.zip


sniffer:
  enable: true
  force-dns-mapping: true
  parse-pure-ip: true
  override-destination: true
  sniff:
    HTTP:
      ports: [80, 8080-8880]
      override-destination: true
    TLS:
      ports: [443, 8443]
    QUIC:
      ports: [443, 8443]
  force-domain:
    - +.v2ex.com

  skip-domain:
    - Mijia Cloud
    - +.push.apple.com
  skip-src-address:
    - 192.168.1.1/24
  skip-dst-address:
    - 91.105.192.0/23
    - 91.108.4.0/22
    - 91.108.8.0/21
    - 91.108.16.0/21
    - 91.108.56.0/22
    - 95.161.64.0/20
    - 149.154.160.0/20
    - 185.76.151.0/24
    - 2001:67c:4e8::/48
    - 2001:b28:f23c::/47
    - 2001:b28:f23f::/48
    - 2a0a:f280:203::/48
tun:
  enable: false
  stack: mixed
  device: utun0
  dns-hijack:
    - any:53
    - tcp://any:53
  auto-route: true
  auto-detect-interface: true
  strict-route: true

dns:
  enable: true
  listen: 0.0.0.0:1053
  ipv6: true
  prefer-h3: true
  use-hosts: true
  use-system-hosts: true
  respect-rules: true
  enhanced-mode: fake-ip
  fake-ip-range: 28.0.0.1/8
  fake-ip-filter:
    - "*"
    - "+.lan"
    - "+.local"
    - "time.*.com"
    - "ntp.*.com"
    - "+.market.xiaomi.com"
  default-nameserver:
    - 223.5.5.5
    - 119.29.29.29
  nameserver:
    - https://120.53.53.53/dns-query#h3=true
    - https://223.6.6.6/dns-query#h3=true
    - https://223.5.5.5/dns-query#h3=true
  proxy-server-nameserver:
    - https://120.53.53.53/dns-query
    - https://223.5.5.5/dns-query




FilterHK: &FilterHK 'ğŸ‡­ğŸ‡°'
FilterJP: &FilterJP 'ğŸ‡¯ğŸ‡µ'
FilterSG: &FilterSG 'ğŸ‡¸ğŸ‡¬'
FilterUS: &FilterUS 'ğŸ‡ºğŸ‡¸'
FilterOther: &FilterOther '^((?!(ğŸ‡­ğŸ‡°|ğŸ‡¸ğŸ‡¬|ğŸ‡ºğŸ‡¸|ğŸ‡¯ğŸ‡µ|æ¸¯|ç¾|æ—¥|å¡|ç‹®|å¹¿å‘Š|å‰©ä½™|å®˜ç½‘|åˆ°æœŸ|æµé‡|HK|US|JP|SG|Hong|Singapore|Japan|United)).)*$'
FilterAll: &FilterAll '^(?=.*(.))(?!.*((?i)ç¾¤|é‚€è¯·|è¿”åˆ©|å¾ªç¯|å®˜ç½‘|å®¢æœ|ç½‘ç«™|ç½‘å€|è·å–|è®¢é˜…|æµé‡|åˆ°æœŸ|æœºåœº|ä¸‹æ¬¡|ç‰ˆæœ¬|å®˜å€|å¤‡ç”¨|è¿‡æœŸ|å·²ç”¨|è”ç³»|é‚®ç®±|å·¥å•|è´©å–|é€šçŸ¥|å€’å–|é˜²æ­¢|å›½å†…|åœ°å€|é¢‘é“|æ— æ³•|è¯´æ˜|ä½¿ç”¨|æç¤º|ç‰¹åˆ«|è®¿é—®|æ”¯æŒ|æ•™ç¨‹|å…³æ³¨|æ›´æ–°|ä½œè€…|åŠ å…¥|(\b(USE|USED|TOTAL|EXPIRE|EMAIL|Panel|Channel|Author)\b|(\d{4}-\d{2}-\d{2}|\d+G)))).*$'



Select: &Select {type: select, disable-udp: false, hidden: false, include-all: true}
UrlTest: &UrlTest {type: url-test, interval: 6, tolerance: 20, lazy: true, url: 'http://latency-test.skk.moe/endpoint', disable-udp: false, timeout: 2000, max-failed-times: 3, hidden: false, include-all: true}
FallBack: &FallBack {type: fallback, interval: 6, lazy: true, url: 'http://latency-test.skk.moe/endpoint', disable-udp: false, timeout: 2000, max-failed-times: 3, hidden: false, include-all: true}
LoadBalance: &LoadBalance {type: load-balance, interval: 6, lazy: true, url: 'http://latency-test.skk.moe/endpoint', disable-udp: false, strategy: consistent-hashing, timeout: 2000, max-failed-times: 3, hidden: false, include-all: true}


Classical: &Classical {type: http, behavior: classical, interval: 86400}
Domain: &Domain {type: http, behavior: domain, interval: 86400}
IP: &IP {type: http, behavior: ipcidr, interval: 86400}


proxy-groups: 
  - {name: Proxy, <<: *FallBack, filter: *FilterAll, icon: https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/Proxy.png}
  - {name: AIGC, <<: *FallBack, filter: *FilterUS, icon: https://raw.githubusercontent.com/Orz-3/mini/master/Color/OpenAI.png}
  - {name: Emby, <<: *Select, filter: *FilterUS, icon: https://raw.githubusercontent.com/Orz-3/mini/master/Color/Emby.png}
  - {name: Netflix, <<: *Select, filter: *FilterSG, icon: https://raw.githubusercontent.com/Orz-3/mini/master/Color/Netflix.png}
  - {name: Spotify, <<: *Select, proxies: [DIRECT], icon: https://raw.githubusercontent.com/Orz-3/mini/master/Color/Spotify.png}  

# åœ°åŒºç­–ç•¥ 
#  - {name: Hong Kong, <<: *FallBack, filter: *FilterHK, icon: https://raw.githubusercontent.com/Orz-3/mini/master/Color/HK.png}
#  - {name: Singapore, <<: *FallBack, filter: *FilterSG, icon: https://raw.githubusercontent.com/Orz-3/mini/master/Color/SG.png}
#  - {name: United States, <<: *FallBack, filter: *FilterUS, icon: https://raw.githubusercontent.com/Orz-3/mini/master/Color/US.png}




rule-providers:
  applications: { <<: *Classical, format: yaml, path: ./rule-providers/applications.txt, url: https://raw.githubusercontent.com/Loyalsoldier/clash-rules/release/applications.txt }
  awavenue_ad_rule: { <<: *Domain, format: yaml, path: ./rule-providers/awavenue_ad_rule.yaml, url: https://raw.githubusercontent.com/TG-Twilight/AWAvenue-Ads-Rule/main/Filters/AWAvenue-Ads-Rule-Clash.yaml }
  reject_non_ip_drop: { <<: *Classical, format: text, path: ./rule-providers/reject_non_ip_drop.txt, url: https://ruleset.skk.moe/Clash/non_ip/reject-drop.txt }
  reject_non_ip: { <<: *Classical, format: text, path: ./rule-providers/reject_non_ip.txt, url: https://ruleset.skk.moe/Clash/non_ip/reject.txt }
  reject_domainset: { <<: *Domain, format: text, path: ./rule-providers/reject_domainset.txt, url: https://ruleset.skk.moe/Clash/domainset/reject.txt }
  private_domain: { <<: *Domain, format: mrs, path: ./rule-providers/private_domain.mrs, url: https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/refs/heads/meta/geo/geosite/private.mrs }
  steam@cn: { <<: *Domain, format: mrs, path: ./rule-providers/steam@cn.mrs, url: https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/refs/heads/meta/geo/geosite/steam@cn.mrs }
  category-games@cn: { <<: *Domain, format: mrs, path: ./rule-providers/category-games@cn.mrs, url: https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/refs/heads/meta/geo/geosite/category-games@cn.mrs }
  apple-cn: { <<: *Domain, format: mrs, path: ./rule-providers/apple-cn.mrs, url: https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/refs/heads/meta/geo/geosite/apple-cn.mrs }
  apple@cn: { <<: *Domain, format: mrs, path: ./rule-providers/apple@cn.mrs, url: https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/refs/heads/meta/geo/geosite/apple@cn.mrs }
  icloud: { <<: *Domain, format: mrs, path: ./rule-providers/icloud.mrs, url: https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/refs/heads/meta/geo/geosite/icloud.mrs }
  microsoft@cn: { <<: *Domain, format: mrs, path: ./rule-providers/microsoft@cn.mrs, url: https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/refs/heads/meta/geo/geosite/microsoft@cn.mrs }
  onedrive: { <<: *Domain, format: mrs, path: ./rule-providers/onedrive.mrs, url: https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/refs/heads/meta/geo/geosite/onedrive.mrs }
  microsoft: { <<: *Domain, format: mrs, path: ./rule-providers/microsoft.mrs, url: https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/refs/heads/meta/geo/geosite/microsoft.mrs }
  telegram_domain: { <<: *Domain, format: mrs, path: ./rule-providers/telegram_domain.mrs, url: https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/refs/heads/meta/geo/geosite/telegram.mrs }
  spotify: { <<: *Domain, format: mrs, path: ./rule-providers/spotify.mrs, url: https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/refs/heads/meta/geo/geosite/spotify.mrs }
  netflix_domain: { <<: *Domain, format: mrs, path: ./rule-providers/netflix_domain.mrs, url: https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/refs/heads/meta/geo/geosite/netflix.mrs }
  category-ai-chat-!cn: { <<: *Domain, format: mrs, path: ./rule-providers/category-ai-chat-!cn.mrs, url: https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/refs/heads/meta/geo/geosite/category-ai-chat-!cn.mrs }
  emby: { <<: *Classical, format: text, path: ./rule-providers/emby.list, url: https://raw.githubusercontent.com/tom2almighty/files/main/Surge/Rules/Emby.list }
  geolocation-!cn: { <<: *Domain, format: mrs, path: ./rule-providers/geolocation-!cn.mrs, url: https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/refs/heads/meta/geo/geosite/geolocation-!cn.mrs }
  cn: { <<: *Domain, format: mrs, path: ./rule-providers/cn.mrs, url: https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/refs/heads/meta/geo/geosite/cn.mrs }
  reject_ip: { <<: *IP, format: text, path: ./rule-providers/reject_ip.txt, url: https://ruleset.skk.moe/Clash/ip/reject.txt }
  private_ip: { <<: *IP, format: mrs, path: ./rule-providers/private_ip.mrs, url: https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/refs/heads/meta/geo/geoip/private.mrs }
  telegram_ip: { <<: *IP, format: mrs, path: ./rule-providers/telegram_ip.mrs, url: https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/refs/heads/meta/geo/geoip/telegram.mrs }
  netflix_ip: { <<: *IP, format: mrs, path: ./rule-providers/netflix_ip.mrs, url: https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/refs/heads/meta/geo/geoip/netflix.mrs }
  cn_ip: { <<: *IP, format: mrs, path: ./rule-providers/cn_ip.mrs, url: https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/refs/heads/meta/geo/geoip/cn.mrs }





rules:
  - AND,((DST-PORT,123),(NETWORK,UDP)),DIRECT
  - RULE-SET,applications,DIRECT
  - AND,((NETWORK,UDP),(DOMAIN-SUFFIX,googlevideo.com)),REJECT
  - RULE-SET,awavenue_ad_rule,REJECT
  - RULE-SET,reject_non_ip_drop,REJECT-DROP
  - RULE-SET,reject_non_ip,REJECT
  - RULE-SET,reject_domainset,REJECT

  - RULE-SET,private_domain,DIRECT
  - RULE-SET,steam@cn,DIRECT
  - RULE-SET,category-games@cn,DIRECT
  - RULE-SET,apple-cn,DIRECT
  - RULE-SET,apple@cn,DIRECT
  - RULE-SET,icloud,DIRECT
  - RULE-SET,microsoft@cn,DIRECT

  - DOMAIN-SUFFIX,onedrive.live.com,Proxy
  - RULE-SET,onedrive,DIRECT
  - RULE-SET,microsoft,Proxy
  - RULE-SET,telegram_domain,Proxy
  - RULE-SET,spotify,Spotify
  - RULE-SET,netflix_domain,Netflix
  - RULE-SET,category-ai-chat-!cn,AIGC
  - RULE-SET,emby,Emby
  - RULE-SET,geolocation-!cn,Proxy
  - DOMAIN-SUFFIX,grew.cc,Proxy
  
  - RULE-SET,cn,DIRECT
  - DOMAIN-SUFFIX,cn,DIRECT
  
  - RULE-SET,reject_ip,REJECT
  - RULE-SET,private_ip,DIRECT,no-resolve
  - RULE-SET,telegram_ip,Proxy,no-resolve
  - RULE-SET,netflix_ip,Netflix,no-resolve
  - RULE-SET,cn_ip,DIRECT,no-resolve

  - MATCH,Proxy
```

é…ç½®ä¸­å¯ç®€åŒ– `rule-providers` éƒ¨åˆ†ä¸º `GEOSITE` åŠ `GEOIP`ã€‚

### æ ¸å¿ƒå¼€æœºè‡ªå¯

ä¸‹è½½å¥½æ ¸å¿ƒåå¯ä»¥é…ç½®å¼€æœºè‡ªå¯æœåŠ¡ã€‚

æ‰“å¼€ä»»åŠ¡è®¡åˆ’ç¨‹åº, ç‚¹å‡»å³ä¾§æ“ä½œåˆ—è¡¨ä¸­çš„â€œåˆ›å»ºä»»åŠ¡â€:

1. å¸¸è§„

   åç§°å¡« `mihomo`ã€‚ `æ›´æ”¹ç”¨æˆ·æˆ–ç»„`ï¼Œ è¾“å…¥ `system`ï¼Œç‚¹å‡» `æ£€æŸ¥åç§°` æŒ‰é’®ï¼Œ å˜ä¸º SYSTEMï¼Œå³ä½¿ç”¨ `SYSTEM` è´¦æˆ·ã€‚

2. è§¦å‘å™¨

   æ–°å»ºï¼Œ`å¼€å§‹ä»»åŠ¡` é€‰æ‹© `ç™»å½•æ—¶` æˆ– `å¯åŠ¨æ—¶`ï¼Œ æŒ‰éœ€é€‰æ‹© `å»¶è¿Ÿä»»åŠ¡æ—¶é—´`ï¼Œ ç¡®è®¤å‹¾é€‰ `å·²å¯ç”¨`ã€‚

3. æ“ä½œ

   æ–°å»ºï¼Œ`æ“ä½œ` é€‰æ‹© `å¯åŠ¨ç¨‹åº`ï¼›`ç¨‹åºæˆ–è„šæœ¬` å¡«å†™ `mihomo.exe`ï¼› `æ·»åŠ å‚æ•°` å¡«å†™ `-d .\ -f config.yaml`ï¼› `èµ·å§‹äº` å¡«å†™ `mihomo` å·¥ä½œç›®å½•ï¼Œå³äºŒè¿›åˆ¶æ–‡ä»¶æ‰€åœ¨ç›®å½•ï¼Œæ¯”å¦‚ `D:\Program\mihomo`ã€‚

   å¸¸ç”¨å‚æ•°å¦‚ä¸‹ï¼Œå¯è‡ªå·±æ­é…ï¼š
   ```bash
     -config string
           specify base64-encoded configuration string
     -d string
           set configuration directory
     -ext-ctl string
           override external controller address
     -ext-ctl-pipe string
           override external controller pipe address
     -ext-ctl-unix string
           override external controller unix address
     -ext-ui string
           override external ui directory
     -f string
           specify configuration file
     -m    set geodata mode
     -secret string
           override secret for RESTful API
     -t    test configuration and exit
     -v    show current version of mihomo
   ```

4. æ¡ä»¶

   å…¨éƒ¨å–æ¶ˆå‹¾é€‰ï¼ŒåŒ…æ‹¬ç°æ˜¾çš„ã€‚

5. è®¾ç½®

   1. ä»…å‹¾é€‰ `å…è®¸æŒ‰éœ€è¿è¡Œä»»åŠ¡`ã€‚
   2. æœ€ä¸‹æ–¹çš„ `å¦‚æœæ­¤ä»»åŠ¡å·²ç»è¿è¡Œ, ä»¥ä¸‹è§„åˆ™é€‚ç”¨`, ç¡®è®¤é€‰æ‹© `è¯·å‹¿å¯åŠ¨æ–°å®ä¾‹`ã€‚

### è„šæœ¬æ–‡ä»¶

ä¸Šè¿°å‚è€ƒé…ç½®ä¸­ï¼Œ `TUN Mode` é»˜è®¤æ˜¯å…³é—­çš„ï¼Œå› æ­¤éœ€è¦å¼€å¯ç³»ç»Ÿä»£ç†ä½¿ç”¨ã€‚

#### è„šæœ¬ä½¿ç”¨æ­¥éª¤

1. å°†è„šæœ¬æ–‡ä»¶æ”¾åœ¨äºŒè¿›åˆ¶æ–‡ä»¶æ‰€åœ¨ç›®å½•ï¼Œåç¼€å¡«å†™ `.ps1`ã€‚

2. å³å‡»è„šæœ¬æ–‡ä»¶ï¼Œå‘é€çš„æ¡Œé¢å¿«æ·æ–¹å¼ã€‚
3. å³å‡»æ¡Œé¢å¿«æ·æ–¹å¼ï¼Œåœ¨ `ç›®æ ‡` å‰å¡«å†™ `powershell.exe" -ExecutionPolicy Bypass -File `ï¼Œå¦‚æœå®‰è£…äº†æ–°ç‰ˆ `powershell`ï¼Œåˆ™æ¢æˆ `pwsh.exe`ã€‚æœ€ç»ˆå¦‚ï¼š`powershell.exe -ExecutionPolicy Bypass -File "Stop.ps1"`
4. åŒæ ·æ¡Œé¢å¿«æ·æ–¹å¼ï¼Œé€‰æ‹© `é«˜çº§`ï¼Œå‹¾é€‰ `ç”¨ç®¡ç†å‘˜æ–¹å¼è¿è¡Œ`ã€‚
5. ç¡®è®¤åè¿è¡Œå³å¯ã€‚


> [!TIP]
>
> ä¸‹é¢çš„å„ä¸ªè„šæœ¬æ–‡ä»¶ä¸­ï¼Œéœ€è¦æ³¨æ„ç›¸å…³å‚æ•°å’Œåç§°å’Œè‡ªå·±çš„é…ç½®åŒ¹é…ï¼š
>
> - `$controller_api`ï¼šé…ç½®æ–‡ä»¶å¤–éƒ¨æ§åˆ¶ API åœ°å€
> - `$api_secret`ï¼šé…ç½®æ–‡ä»¶å¤–éƒ¨æ§åˆ¶ API å¯†é’¥
> - `$task`ï¼šä»»åŠ¡è®¡åˆ’ç¨‹åºåç§°
> - `$proxy_port`ï¼šé…ç½®æ–‡ä»¶ä»£ç†ç«¯å£



#### å¯åŠ¨ç³»ç»Ÿä»£ç†

```powershell
$ErrorActionPreference = 'SilentlyContinue'

# é…ç½®å‚æ•°
$controller_api = "http://127.0.0.1:9090"
$api_secret = ""
$task = "mihomo"
$proxy_port = 7890

# å‡½æ•°ï¼šå¼¹çª—é€šçŸ¥
function Show-Notification {
    param($message)
    Add-Type -AssemblyName System.Windows.Forms
    [System.Windows.Forms.MessageBox]::Show(
        $message,
        "ç³»ç»Ÿä»£ç†æ¨¡å¼å·²å¯ç”¨",
        [System.Windows.Forms.MessageBoxButtons]::OK,
        [System.Windows.Forms.MessageBoxIcon]::Information
    )
}

try {
    # 1. æ£€æŸ¥å¹¶å¯åŠ¨å†…æ ¸
    $state = Get-ScheduledTask -TaskName $task | Select-Object -ExpandProperty State
    if ($state -ne "Running") {
        Start-ScheduledTask -TaskName $task
        Start-Sleep -Seconds 3
        $state = Get-ScheduledTask -TaskName $task | Select-Object -ExpandProperty State
        if ($state -ne "Running") {
            Write-Host "âŒ å¯åŠ¨å†…æ ¸å¤±è´¥" -ForegroundColor Red
            exit 1
        }
    }

    # 2. å¯ç”¨ç³»ç»Ÿä»£ç†
    Set-ItemProperty -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Internet Settings' -Name ProxyEnable -Value 1
    Set-ItemProperty -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Internet Settings' -Name ProxyServer -Value "127.0.0.1:$proxy_port"
    Set-ItemProperty -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Internet Settings' -Name ProxyOverride -Value "localhost;127.*;10.*;172.16.*;172.17.*;172.18.*;172.19.*;172.20.*;172.21.*;172.22.*;172.23.*;172.24.*;172.25.*;172.26.*;172.27.*;172.28.*;172.29.*;172.30.*;172.31.*;192.168.*;<local>"
    
    # ç«‹å³ç”Ÿæ•ˆä»£ç†è®¾ç½®
    rundll32.exe wininet.dll,InternetSetOptionA 0 39 0 0
    rundll32.exe wininet.dll,InternetSetOptionA 0 37 0 0

    # 3. ç¦ç”¨TUNæ¨¡å¼
    $null = Invoke-RestMethod -Headers @{ "Authorization" = "Bearer $api_secret" } `
        -ContentType "application/json" `
        -Method PATCH `
        -Body '{"tun": {"enable": false}}' `
        -Uri "$controller_api/configs"

    # æˆåŠŸåé¦ˆ
    Write-Host "âœ… ç³»ç»Ÿä»£ç†å·²å¯ç”¨ (ç«¯å£ $proxy_port)" -ForegroundColor Green
    Write-Host "âœ… TUNæ¨¡å¼å·²ç¦ç”¨" -ForegroundColor Green
    Show-Notification "ç³»ç»Ÿä»£ç†å·²å¯ç”¨`nç«¯å£: $proxy_port`nTUNæ¨¡å¼å·²å…³é—­"
}
catch {
    Write-Host "âŒ æ“ä½œå¤±è´¥: $($_.Exception.Message)" -ForegroundColor Red
    exit 1
}
```

#### å…³é—­ç³»ç»Ÿä»£ç†

```powershell
$ErrorActionPreference = 'SilentlyContinue'

# å‡½æ•°ï¼šå¼¹çª—é€šçŸ¥
function Show-Notification {
    param($message)
    Add-Type -AssemblyName System.Windows.Forms
    [System.Windows.Forms.MessageBox]::Show(
        $message,
        "ç³»ç»Ÿä»£ç†è®¾ç½®",
        [System.Windows.Forms.MessageBoxButtons]::OK,
        [System.Windows.Forms.MessageBoxIcon]::Information
    )
}

try {
    # 1. ç¦ç”¨ç³»ç»Ÿä»£ç†æ³¨å†Œè¡¨è®¾ç½®
    Set-ItemProperty -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Internet Settings' `
        -Name ProxyEnable `
        -Value 0 `
        -ErrorAction Stop

    Set-ItemProperty -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Internet Settings' `
        -Name ProxyServer `
        -Value "" `
        -ErrorAction Stop

    # 2. ç«‹å³ç”Ÿæ•ˆä»£ç†è®¾ç½®
    rundll32.exe wininet.dll,InternetSetOptionA 0 39 0 0
    rundll32.exe wininet.dll,InternetSetOptionA 0 37 0 0

    # 3. åé¦ˆç»“æœ
    Write-Host "âœ… ç³»ç»Ÿä»£ç†å·²å…³é—­" -ForegroundColor Green
    Show-Notification "ç³»ç»Ÿä»£ç†å·²æˆåŠŸå…³é—­"
}
catch {
    Write-Host "âŒ å…³é—­ä»£ç†å¤±è´¥: $($_.Exception.Message)" -ForegroundColor Red
    exit 1
}
```

#### å¯åŠ¨æ ¸å¿ƒ-ç³»ç»Ÿä»£ç†

```powershell
$ErrorActionPreference = 'SilentlyContinue'

# é…ç½®å‚æ•°
$controller_api = "http://127.0.0.1:9090"
$api_secret = ""
$task = "mihomo"
$proxy_port = 7890

# å‡½æ•°ï¼šå¼¹çª—é€šçŸ¥
function Show-Notification {
    param($message)
    Add-Type -AssemblyName System.Windows.Forms
    [System.Windows.Forms.MessageBox]::Show(
        $message,
        "ç³»ç»Ÿä»£ç†æ¨¡å¼å·²å¯ç”¨",
        [System.Windows.Forms.MessageBoxButtons]::OK,
        [System.Windows.Forms.MessageBoxIcon]::Information
    )
}

try {
    # 1. æ£€æŸ¥å¹¶å¯åŠ¨å†…æ ¸
    $state = Get-ScheduledTask -TaskName $task | Select-Object -ExpandProperty State
    if ($state -ne "Running") {
        Start-ScheduledTask -TaskName $task
        Start-Sleep -Seconds 3
        $state = Get-ScheduledTask -TaskName $task | Select-Object -ExpandProperty State
        if ($state -ne "Running") {
            Write-Host "âŒ å¯åŠ¨å†…æ ¸å¤±è´¥" -ForegroundColor Red
            exit 1
        }
    }

    # 2. å¯ç”¨ç³»ç»Ÿä»£ç†
    Set-ItemProperty -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Internet Settings' -Name ProxyEnable -Value 1
    Set-ItemProperty -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Internet Settings' -Name ProxyServer -Value "127.0.0.1:$proxy_port"
    Set-ItemProperty -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Internet Settings' -Name ProxyOverride -Value "localhost;127.*;10.*;172.16.*;172.17.*;172.18.*;172.19.*;172.20.*;172.21.*;172.22.*;172.23.*;172.24.*;172.25.*;172.26.*;172.27.*;172.28.*;172.29.*;172.30.*;172.31.*;192.168.*;<local>"
    
    # ç«‹å³ç”Ÿæ•ˆä»£ç†è®¾ç½®
    rundll32.exe wininet.dll,InternetSetOptionA 0 39 0 0
    rundll32.exe wininet.dll,InternetSetOptionA 0 37 0 0

    # 3. ç¦ç”¨TUNæ¨¡å¼
    $null = Invoke-RestMethod -Headers @{ "Authorization" = "Bearer $api_secret" } `
        -ContentType "application/json" `
        -Method PATCH `
        -Body '{"tun": {"enable": false}}' `
        -Uri "$controller_api/configs"

    # æˆåŠŸåé¦ˆ
    Write-Host "âœ… ç³»ç»Ÿä»£ç†å·²å¯ç”¨ (ç«¯å£ $proxy_port)" -ForegroundColor Green
    Write-Host "âœ… TUNæ¨¡å¼å·²ç¦ç”¨" -ForegroundColor Green
    Show-Notification "ç³»ç»Ÿä»£ç†å·²å¯ç”¨`nç«¯å£: $proxy_port`nTUNæ¨¡å¼å·²å…³é—­"
}
catch {
    Write-Host "âŒ æ“ä½œå¤±è´¥: $($_.Exception.Message)" -ForegroundColor Red
    exit 1
}
```

#### å¯åŠ¨æ ¸å¿ƒ-TUN

```powershell
$ErrorActionPreference = 'SilentlyContinue'

# é…ç½®å‚æ•°
$controller_api = "http://127.0.0.1:9090"
$api_secret = ""
$task = "mihomo"

# å‡½æ•°ï¼šå¼¹çª—é€šçŸ¥
function Show-Notification {
    param($message)
    Add-Type -AssemblyName System.Windows.Forms
    [System.Windows.Forms.MessageBox]::Show(
        $message,
        "TUNæ¨¡å¼å·²å¯ç”¨",
        [System.Windows.Forms.MessageBoxButtons]::OK,
        [System.Windows.Forms.MessageBoxIcon]::Information
    )
}

try {
    # 1. æ£€æŸ¥å¹¶å¯åŠ¨å†…æ ¸
    $state = Get-ScheduledTask -TaskName $task | Select-Object -ExpandProperty State
    if ($state -ne "Running") {
        Start-ScheduledTask -TaskName $task
        Start-Sleep -Seconds 3
        $state = Get-ScheduledTask -TaskName $task | Select-Object -ExpandProperty State
        if ($state -ne "Running") {
            Write-Host "âŒ å¯åŠ¨å†…æ ¸å¤±è´¥" -ForegroundColor Red
            exit 1
        }
    }

    # 2. å…³é—­ç³»ç»Ÿä»£ç†
    Set-ItemProperty -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Internet Settings' -Name ProxyEnable -Value 0
    Set-ItemProperty -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Internet Settings' -Name ProxyServer -Value ""
    
    # ç«‹å³ç”Ÿæ•ˆä»£ç†è®¾ç½®
    rundll32.exe wininet.dll,InternetSetOptionA 0 39 0 0
    rundll32.exe wininet.dll,InternetSetOptionA 0 37 0 0

    # 3. å¯ç”¨TUNæ¨¡å¼
    $null = Invoke-RestMethod -Headers @{ "Authorization" = "Bearer $api_secret" } `
        -ContentType "application/json" `
        -Method PATCH `
        -Body '{"tun": {"enable": true}}' `
        -Uri "$controller_api/configs"

    # æˆåŠŸåé¦ˆ
    Write-Host "âœ… ç³»ç»Ÿä»£ç†å·²å…³é—­" -ForegroundColor Green
    Write-Host "âœ… TUNæ¨¡å¼å·²å¯ç”¨" -ForegroundColor Green
    Show-Notification "ç³»ç»Ÿä»£ç†å·²å…³é—­`nTUNæ¨¡å¼å·²å¯ç”¨"
}
catch {
    Write-Host "âŒ æ“ä½œå¤±è´¥: $($_.Exception.Message)" -ForegroundColor Red
    exit 1
}
```

#### åˆ‡æ¢æ¨¡å¼

```powershell
$ErrorActionPreference = 'Stop'

# é…ç½®å‚æ•°
$controller_api = "http://127.0.0.1:9090"
$api_secret = ""
$proxy_port = 7890
$registryPath = 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Internet Settings'

# å‡½æ•°ï¼šç»Ÿä¸€æ³¨å†Œè¡¨æ“ä½œ
function Update-ProxySettings {
    param(
        [bool]$enable,
        [string]$proxyServer = ""
    )
    try {
        Set-ItemProperty -Path $registryPath -Name ProxyEnable -Value ([int]$enable) -ErrorAction Stop
        Set-ItemProperty -Path $registryPath -Name ProxyServer -Value $proxyServer -ErrorAction Stop
        if ($enable) {
            Set-ItemProperty -Path $registryPath -Name ProxyOverride -Value "localhost;127.*;10.*;172.16.*;172.17.*;172.18.*;172.19.*;172.20.*;172.21.*;172.22.*;172.23.*;172.24.*;172.25.*;172.26.*;172.27.*;172.28.*;172.29.*;172.30.*;172.31.*;192.168.*;<local>" -ErrorAction Stop
        }
        
        # åŒåˆ·æ–°æœºåˆ¶ç¡®ä¿ç«‹å³ç”Ÿæ•ˆ
        rundll32.exe wininet.dll,InternetSetOptionA 0 39 0 0 | Out-Null
        rundll32.exe wininet.dll,InternetSetOptionA 0 37 0 0 | Out-Null
    }
    catch {
        Write-Host "âŒ ä»£ç†è®¾ç½®å¤±è´¥: $($_.Exception.Message)" -ForegroundColor Red
        throw
    }
}

# å‡½æ•°ï¼šå¢å¼ºAPIè°ƒç”¨ï¼ˆå«é‡è¯•é€»è¾‘ï¼‰
function Update-TunMode {
    param([bool]$enable)
    try {
        $body = @{ tun = @{ enable = $enable } } | ConvertTo-Json -Compress
        $null = Invoke-RestMethod -Headers @{ "Authorization" = "Bearer $api_secret" } `
            -ContentType "application/json" `
            -Method PATCH `
            -Body $body `
            -Uri "$controller_api/configs" `
            -ErrorAction Stop `
            -TimeoutSec 3  # æ·»åŠ è¶…æ—¶é™åˆ¶
        
        Write-Host "TUNæ¨¡å¼å·²åˆ‡æ¢: $(if ($enable) {'å¯ç”¨'} else {'å…³é—­'})" -ForegroundColor DarkGray
    }
    catch {
        Write-Host "âŒ TUNæ¨¡å¼åˆ‡æ¢å¤±è´¥: $($_.Exception.Message)" -ForegroundColor Red
        throw
    }
}

# å‡½æ•°ï¼šå¢å¼ºå‹é€šçŸ¥
function Show-SwitchStatus {
    param($proxyStatus, $tunStatus)
    Add-Type -AssemblyName System.Windows.Forms
    $icon = [System.Windows.Forms.MessageBoxIcon]::Information
    $title = "ä»£ç†æ¨¡å¼åˆ‡æ¢"
    
    # æ§åˆ¶å°é¢œè‰²åé¦ˆ
    Write-Host "`nå½“å‰çŠ¶æ€ï¼š" -ForegroundColor Cyan
    Write-Host "â€¢ ç³»ç»Ÿä»£ç†: $proxyStatus" -ForegroundColor $(if ($proxyStatus -eq "å¯ç”¨") { "Green" } else { "Yellow" })
    Write-Host "â€¢ TUNæ¨¡å¼:  $tunStatus`n" -ForegroundColor $(if ($tunStatus -eq "å¯ç”¨") { "Green" } else { "Yellow" })
    
    # å¼¹çª—é€šçŸ¥
    [System.Windows.Forms.MessageBox]::Show(
        "ç³»ç»Ÿä»£ç†: $proxyStatus`nTUNæ¨¡å¼: $tunStatus",
        $title,
        [System.Windows.Forms.MessageBoxButtons]::OK,
        $icon
    )
    
    # ç³»ç»Ÿæç¤ºéŸ³
    [System.Media.SystemSounds]::Exclamation.Play()
}

try {
    # è·å–å½“å‰ä»£ç†çŠ¶æ€
    $currentProxy = [bool](Get-ItemPropertyValue -Path $registryPath -Name ProxyEnable -ErrorAction Stop)

    # æ ¸å¿ƒåˆ‡æ¢é€»è¾‘
    if ($currentProxy) {
        Update-ProxySettings -enable $false
        Update-TunMode -enable $true
        Show-SwitchStatus -proxyStatus "å…³é—­" -tunStatus "å¯ç”¨"
    }
    else {
        Update-ProxySettings -enable $true -proxyServer "127.0.0.1:$proxy_port"
        Update-TunMode -enable $false
        Show-SwitchStatus -proxyStatus "å¯ç”¨" -tunStatus "å…³é—­"
    }
}
catch {
    Write-Host "`nâŒ åˆ‡æ¢å¤±è´¥: $($_.Exception.Message)" -ForegroundColor Red
    [System.Media.SystemSounds]::Hand.Play()
    exit 1
}
```

#### åœæ­¢æ ¸å¿ƒå¹¶å…³é—­ç³»ç»Ÿä»£ç†

```powershell
$process = "mihomo-windows-amd64"

Set-ItemProperty -Path 'Registry::HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings' -Name ProxyEnable -Value 0
Write-Host "System proxy disabled."
Stop-Process -Name $process -Force > $null 2>&1
Write-Host "${process} stopped."
Clear-DnsClientCache
Start-Sleep -Seconds 1
```

### UWPåº”ç”¨

å¯¹äºä¸èµ°ç³»ç»Ÿä»£ç†çš„åº”ç”¨ï¼Œå¯ä»¥ä½¿ç”¨ `Windows 8 AppContainer Loopback Utility`ï¼Œåœ°å€å’Œä¸‹è½½é“¾æ¥å¦‚ä¸‹ï¼š

- [åœ°å€](https://www.telerik.com/fiddler/add-ons)
- [ä¸‹è½½åœ°å€](https://telerik-fiddler.s3.amazonaws.com/fiddler/addons/enableloopbackutility.exe)

### WebUI

å¯¹äºåˆ‡æ¢èŠ‚ç‚¹å¯ä»¥ä½¿ç”¨ `WebUI`ï¼Œé…ç½®æ–‡ä»¶ä¸­æŒ‡å®šä¸‹è½½é“¾æ¥åå¯ä»¥é€šè¿‡ä¸‹é¢çš„é“¾æ¥æ‰“å¼€ï¼Œæ›´æ¢è‡ªå·±çš„å¯†é’¥ï¼š

```bash
http://127.0.0.1:9090/#/setup?hostname=127.0.0.1&port=9090&secret=123456
```

æ¨èä¸¤ä¸ªæ§åˆ¶é¢æ¿ï¼š

- [ZashBoard](https://github.com/Zephyruso/zashboard)
- [MetaCubeXD](https://github.com/MetaCubeX/metacubexd)

## å‚è€ƒ

- [Clash on Windows](https://senzyo.net/2023-7)

