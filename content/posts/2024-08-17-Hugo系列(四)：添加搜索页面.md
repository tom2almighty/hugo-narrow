---
categories: 
- å®ç”¨æ•™ç¨‹
cover: ''
date: 2024-08-17 19:02:35+08:00
description: é€šè¿‡è‡ªå®šä¹‰ JS ç»™ Hugo Diary ä¸»é¢˜æ·»åŠ ä¸€ä¸ªæœç´¢é¡µé¢
slug: hugo-diary-search
summary: é€šè¿‡è‡ªå®šä¹‰ JS ç»™ Hugo Diary ä¸»é¢˜æ·»åŠ ä¸€ä¸ªæœç´¢é¡µé¢
tags:
- Hugo
title: Hugoç³»åˆ—(å››)ï¼šæ·»åŠ æœç´¢é¡µé¢
---
## å‰è¨€

`Hugo Diary` ä¸»é¢˜æ²¡æœ‰è‡ªå¸¦çš„æœç´¢é¡µé¢ï¼Œæ–‡ç« å¤šäº†åæ‰¾ç¬”è®°ä¸æ–¹ä¾¿ï¼Œå› æ­¤æƒ³ç»™ä¸»é¢˜æ·»åŠ ä¸€ä¸ªæœç´¢é¡µé¢ï¼Œæœ€ç»ˆè€—æ—¶ä¸€å¤©æˆåŠŸæ·»åŠ ã€‚

## è¿‡ç¨‹

æœ€å¼€å§‹å‘ç°ä¸€ç¯‡æ–‡ç«  [5åˆ†é’Ÿç»™Hugoåšå®¢å¢åŠ æœç´¢åŠŸèƒ½](https://ttys3.dev/blog/hugo-fast-search) å¼•å…¥ `fuse.js` æ–‡ä»¶å®ç°æœç´¢ï¼Œæœ€ç»ˆæ•ˆæœæ˜¯é¡µé¢å‡ºç°ä¸€ä¸ªæœç´¢æŒ‰é’®ï¼Œç‚¹å‡»ä¼šå‡ºç°ä¸€ä¸ªæœç´¢æ¡†ï¼Œç„¶åå¯ä»¥æœç´¢å†…å®¹ï¼Œå‘ˆç°ç¬¦åˆçš„æ–‡ç« æ ‡é¢˜åˆ—è¡¨ï¼Œè²Œä¼¼ç”±äºä¸»é¢˜çš„æ¨¡æ¿å†™æ³•ï¼Œä½¿ç”¨è¿™ç§æ–¹æ³•åœ¨æ¡Œé¢ç«¯å’Œç§»åŠ¨ç«¯çš„ `html` æ–‡ä»¶ä¸­æ·»åŠ ä¼šè¦†ç›–ä¸Šä¸€ä¸ªå¼•å…¥çš„æ¨¡æ¿ï¼Œå¹¶ä¸”æŒ‰é’®çš„ä½ç½®è°ƒæ•´ä¹Ÿæ¯”è¾ƒéº»çƒ¦ï¼Œå› æ­¤ä½œç½¢ã€‚

éšååœ¨[å¦ä¸€ç¯‡æ–‡ç« ](https://sobaigu.com/hugo-set-featuer-search.html)ä¸­çœ‹åˆ°å¯ä»¥é€šè¿‡åˆ›å»ºæœç´¢æ¨¡æ¿æ–‡ä»¶æ¥ç”Ÿæˆæœç´¢é¡µé¢ï¼Œè¿™æ ·ä¹Ÿä¸éœ€è¦è¿›è¡Œå¤§çš„æ ·å¼è°ƒæ•´ï¼Œæ‰€ä»¥ä½¿ç”¨è¿™ç§æ–¹æ³•ï¼ŒæˆåŠŸåå‘ç°è¿™ç§æœç´¢æ–¹æ³•å¯¹ä¸­æ–‡å¹¶ä¸ç”Ÿæ•ˆï¼Œä¸ä¼šæœç´¢ä¸­æ–‡å†…å®¹ï¼Œå°è¯•å¼•å…¥ç»“å·´åˆ†è¯çš„ `JS` åº“ï¼Œä½†æ˜¯æ²¡æ‰¾åˆ°ç°æˆçš„ï¼Œè¿˜è€æŠ¥é”™ï¼Œå› æ­¤å†æ¬¡å¯»æ‰¾å…¶ä»–æ–¹æ³•ã€‚

æƒ³åˆ°ä¹‹å‰ä½¿ç”¨çš„ `Stack` ä¸»é¢˜æœ‰æœç´¢é¡µé¢ï¼Œå¹¶ä¸”ä¸­æ–‡çš„æœç´¢ä¹Ÿä¸é”™ï¼Œæ‰€ä»¥å°è¯•å°†å…¶ä¸­çš„ `TypeScript` ä»£ç è½¬æ¢æˆ `js` åå¼•å…¥ï¼Œæœ€ç»ˆæˆåŠŸï¼Œæ¥ä¸‹æ¥è®°å½•ä¸€ä¸‹è¯¦ç»†çš„æ­¥éª¤ã€‚

> [!IMPORTANT]
> æ–‡ä¸­æ‰€ä½¿ç”¨çš„ç«™ç‚¹ç»“æ„ä»¥åŠéƒ¨åˆ† `SCSS` æ ·å¼å˜é‡ä»…é€‚ç”¨äº Diary ä¸»é¢˜ï¼Œå¦‚æœè¦å¼•å…¥å…¶ä»–ä¸»é¢˜è®°å¾—æ›´æ”¹


## æ­¥éª¤

### é…ç½®æ–‡ä»¶

é¦–å…ˆåœ¨é…ç½®æ–‡ä»¶ `config.yaml` ä¸­æ·»åŠ è¾“å‡ºæ•°æ®ä»£ç ï¼š

```yaml
[outputs]
  home = ["HTML", "RSS", "JSON"]
```

é¡ºå¸¦æ·»åŠ ä¸€ä¸ªèœå•å­é¡µé¢ï¼š

```yaml
[[menu.main]]
url = "/search"
name = "ğŸ” æœç´¢"
weight = 6
```

ç„¶ååœ¨ `~/content/` æ–‡ä»¶å¤¹æ–°å»º `search.md` æ–‡ä»¶ï¼Œ`Front Matter` å¡«å†™å¦‚ä¸‹ï¼š

```yaml
---
title: "æœç´¢"
layout: "search"
---
```

### åˆ›å»ºæ•°æ®ç´¢å¼•æ–‡ä»¶

åœ¨ `~/layouts/_default/` æ–‡ä»¶å¤¹ä¸‹æ–°å»º `index.json` æ–‡ä»¶ï¼Œå†™å…¥å†…å®¹ï¼Œå­—å…¸å†…çš„ç´¢å¼•å˜é‡å¯ä»¥è‡ªå®šä¹‰ã€‚

```json
{{- $.Scratch.Add "index" slice -}}
{{- range .Site.RegularPages -}}
    {{- $.Scratch.Add "index" (dict "title" .Title "tags" .Params.tags "categories" .Params.categories "content" .Plain "permalink" .Permalink "date" .Date "section" .Section ) -}}
{{- end -}}
{{- $.Scratch.Get "index" | jsonify -}}
```

å®Œæˆåå¯ä»¥é€šè¿‡ `http://localhost:1313/index.json` æŸ¥çœ‹æ˜¯å¦æˆåŠŸç”Ÿæˆæ•°æ®ï¼Œä»¥åŠæ˜¯å¦æœ‰æƒ³è¦çš„å­—æ®µã€‚

### åˆ›å»º JS æ–‡ä»¶

åœ¨ `~/static/js` æ–‡ä»¶å¤¹ä¸‹æ–°å»º `search.js` æ–‡ä»¶ï¼Œå†™å…¥æœç´¢ä»£ç ï¼š

```js
/**
 * Escape HTML tags as HTML entities
 * Edited from:
 * @link https://stackoverflow.com/a/5499821
 */
const tagsToReplace = {
  '&': '&amp;',
  '<': '&lt;',
  '>': '&gt;',
  '"': '&quot;',
  'â€¦': '&hellip;'
};
function replaceTag(tag) {
  return tagsToReplace[tag] || tag;
}
function replaceHTMLEnt(str) {
  return str.replace(/[&<>"]/g, replaceTag);
}
function escapeRegExp(string) {
  return string.replace(/[.*+\-?^${}()|[\]\\]/g, '\\$&');
}

function Search({ form, input, list, resultTitle, resultTitleTemplate }) {
  this.form = form;
  this.input = input;
  this.list = list;
  this.resultTitle = resultTitle;
  this.resultTitleTemplate = resultTitleTemplate;
  this.data = null; // ç”¨äºç¼“å­˜è·å–çš„æ•°æ®
  this.handleQueryString();
  this.bindQueryStringChange();
  this.bindSearchForm();
}

/**
* Processes search matches
* @param str original text
* @param matches array of matches
* @param ellipsis whether to add ellipsis to the end of each match
* @param charLimit max length of preview string
* @param offset how many characters before and after the match to include in preview
* @returns preview string
*/
Search.processMatches = function (str, matches, ellipsis = true, charLimit = 140, offset = 20) {
  matches.sort((a, b) => {
      return a.start - b.start;
  });
  let i = 0, lastIndex = 0, charCount = 0;
  const resultArray = [];
  while (i < matches.length) {
      const item = matches[i];
      if (ellipsis && item.start - offset > lastIndex) {
          resultArray.push(`${replaceHTMLEnt(str.substring(lastIndex, lastIndex + offset))} [...] `);
          resultArray.push(`${replaceHTMLEnt(str.substring(item.start - offset, item.start))}`);
          charCount += offset * 2;
      } else {
          resultArray.push(replaceHTMLEnt(str.substring(lastIndex, item.start)));
          charCount += item.start - lastIndex;
      }
      let j = i + 1, end = item.end;
      while (j < matches.length && matches[j].start <= end) {
          end = Math.max(matches[j].end, end);
          ++j;
      }
      resultArray.push(`<mark>${replaceHTMLEnt(str.substring(item.start, end))}</mark>`);
      charCount += end - item.start;
      i = j;
      lastIndex = end;
      if (ellipsis && charCount > charLimit) break;
  }
  if (lastIndex < str.length) {
      let end = str.length;
      if (ellipsis) end = Math.min(end, lastIndex + offset);
      resultArray.push(`${replaceHTMLEnt(str.substring(lastIndex, end))}`);
      if (ellipsis && end !== str.length) {
          resultArray.push(` [...]`);
      }
  }
  return resultArray.join('');
};

Search.prototype.searchKeywords = async function (keywords) {
  const rawData = await this.getData();
  const results = [];
  const regex = new RegExp(keywords.filter((v, index, arr) => {
      arr[index] = escapeRegExp(v);
      return v.trim() !== '';
  }).join('|'), 'gi');
  for (const item of rawData) {
      const titleMatches = [], contentMatches = [];
      let result = Object.assign({}, item, { preview: '', matchCount: 0 });
      const contentMatchAll = item.content.matchAll(regex);
      for (const match of Array.from(contentMatchAll)) {
          contentMatches.push({
              start: match.index,
              end: match.index + match[0].length
          });
      }
      const titleMatchAll = item.title.matchAll(regex);
      for (const match of Array.from(titleMatchAll)) {
          titleMatches.push({
              start: match.index,
              end: match.index + match[0].length
          });
      }
      if (titleMatches.length > 0) {
          result.title = Search.processMatches(result.title, titleMatches, false);
      }
      if (contentMatches.length > 0) {
          result.preview = Search.processMatches(result.content, contentMatches);
      } else {
          result.preview = replaceHTMLEnt(result.content.substring(0, 140));
      }
      result.matchCount = titleMatches.length + contentMatches.length;
      if (result.matchCount > 0) results.push(result);
  }
  return results.sort((a, b) => b.matchCount - a.matchCount);
};

Search.prototype.doSearch = async function (keywords) {
  const startTime = performance.now();
  const results = await this.searchKeywords(keywords);
  this.clear();
  for (const item of results) {
      this.list.appendChild(Search.render(item));
  }
  const endTime = performance.now();
  this.resultTitle.innerText = this.generateResultTitle(results.length, ((endTime - startTime) / 1000).toPrecision(1));
};

Search.prototype.generateResultTitle = function (resultLen, time) {
  return this.resultTitleTemplate.replace("#PAGES_COUNT", resultLen).replace("#TIME_SECONDS", time);
};

Search.prototype.getData = async function () {
  if (!this.data) {
      const jsonURL = this.form.dataset.json;
      this.data = await fetch(jsonURL).then(res => res.json());
      const parser = new DOMParser();
      for (const item of this.data) {
          item.content = parser.parseFromString(item.content, 'text/html').body.innerText;
      }
  }
  return this.data;
};

Search.prototype.bindSearchForm = function () {
  let lastSearch = '';
  const eventHandler = (e) => {
      e.preventDefault();
      const keywords = this.input.value.trim();
      Search.updateQueryString(keywords, true);
      if (keywords === '') {
          lastSearch = '';
          return this.clear();
      }
      if (lastSearch === keywords) return;
      lastSearch = keywords;
      this.doSearch(keywords.split(' '));
  };
  this.input.addEventListener('input', eventHandler);
  this.input.addEventListener('compositionend', eventHandler);
};

Search.prototype.clear = function () {
  this.list.innerHTML = '';
  this.resultTitle.innerText = '';
};

Search.prototype.bindQueryStringChange = function () {
  window.addEventListener('popstate', () => {
      this.handleQueryString();
  });
};

Search.prototype.handleQueryString = function () {
  const pageURL = new URL(window.location.toString());
  const keywords = pageURL.searchParams.get('keyword');
  this.input.value = keywords;
  if (keywords) {
      this.doSearch(keywords.split(' '));
  } else {
      this.clear();
  }
};

Search.updateQueryString = function (keywords, replaceState = false) {
  const pageURL = new URL(window.location.toString());
  if (keywords === '') {
      pageURL.searchParams.delete('keyword');
  } else {
      pageURL.searchParams.set('keyword', keywords);
  }
  if (replaceState) {
      window.history.replaceState('', '', pageURL.toString());
  } else {
      window.history.pushState('', '', pageURL.toString());
  }
};

Search.render = function (item) {
  const article = document.createElement("article");

  const link = document.createElement("a");
  link.href = item.permalink;

  const detailsDiv = document.createElement("div");
  detailsDiv.className = "article-details";

  const title = document.createElement("h2");
  title.className = "article-title";
  title.innerHTML = item.title;
  detailsDiv.appendChild(title);

  const preview = document.createElement("section");
  preview.className = "article-preview";
  preview.innerHTML = item.preview;
  detailsDiv.appendChild(preview);

  link.appendChild(detailsDiv);

  article.appendChild(link);

  return article;
};


window.addEventListener('load', () => {
  setTimeout(() => {
      const searchForm = document.querySelector('.search-form');
      const searchInput = searchForm.querySelector('input');
      const searchResultList = document.querySelector('.search-result--list');
      const searchResultTitle = document.querySelector('.search-result--title');
      
      new Search({
          form: searchForm,
          input: searchInput,
          list: searchResultList,
          resultTitle: searchResultTitle,
          resultTitleTemplate: window.searchResultTitleTemplate
      });
  }, 0);
});
```

> [!TIP]
> æ­¤æœç´¢ä»£ç ä½¿ç”¨ `ChatGPT` å°† [Hugo Stack](https://github.com/CaiJimmy/hugo-theme-stack/blob/master/assets/ts/search.tsx) ä¸»é¢˜çš„ `search.tsx` æ–‡ä»¶è½¬æ¢æˆ `js` æ–‡ä»¶ï¼Œå¹¶å°†å…¶ä¸­çš„ `React` åŠæ¨¡å—åŒ–ç›¸å…³ä»£ç ä½¿ç”¨åŸç”Ÿå®ç°ï¼Œå»é™¤äº†å°é¢å›¾ç‰‡ç›¸å…³ä»£ç ã€‚


### åˆ›å»ºæ¨¡æ¿æ–‡ä»¶

æ–°å»º `~/layouts/_default/search.html` æ¨¡æ¿æ–‡ä»¶ï¼Œå¡«å…¥å†…å®¹ï¼š

```html
{{ define "main" }}

<div class="post-list-container post-list-container-shadow">
  <a class="a-block">
    <div class="post-item-wrapper post-item-wrapper-no-hover">
      <div class="post-item post-item-no-gaps">
        <div class="post-item-info-wrapper">
          <div class="post-item-title post-item-title-small">
            {{.Title}}
          </div>
        </div>
      </div>
    </div>
  </a>
<!-- æœç´¢è¡¨å•ç»„ä»¶ -->
<form class="search-form" data-json="/index.json">
    <input type="text" placeholder="Search..." aria-label="Search" />
</form>
<div class="search-result--title">Results</div>
<ul class="search-result--list">
    <article>
        <a href="your-link">
            <div class="article-details">
                <h2 class="article-title"><a href="your-link">Article Title</a></h2>
                <section class="article-preview">This is a preview of the content with <mark>highlighted</mark> text.</section>
            </div>
        </a>
    </article>
</ul>


<script src="{{ "js/search.js" | relURL }}"></script>
<script>
    window.searchResultTitleTemplate = 'Found #PAGES_COUNT results in #TIME_SECONDS seconds';
</script>

{{ end }}
```

> **æ³¨æ„**ï¼šæ€»ä½“çš„å¸ƒå±€æ˜¯ `Diary` ä¸»é¢˜ï¼Œå¦‚æœæ˜¯å…¶ä»–ä¸»é¢˜è¯·ä½¿ç”¨ç›¸åº”çš„æ¨¡æ¿ã€‚

### æ ·å¼ä¿®æ”¹

åœ¨ `~/assets/scss/custom.scss` ä¸­å†™å…¥æœç´¢æ¡†åŠæœç´¢å†…å®¹çš„æ ·å¼ï¼š

```scss
// æœç´¢é¡µé¢æ ·å¼
input{
  width: 100%;
  height: 40px;
  border-radius: 6px;
  border: 2px solid lighten($color-accent, 10%);
  background: #f5f5f5;
  body.night & {
    background: #333;
    border-color: 2px solid darken($color-accent, 10%);
    color: #e6e6e6;
  }
}
.search-result--title {
  font-size: 1.25rem;
  margin: 16px;
  color: #555;
  body.night & {
    color: #e6e6e6;
  }
}
// æ ·å¼ç”¨äºæœç´¢ç»“æœçš„æ•´ä½“å®¹å™¨
.search-result--list {
  margin: 0;
  padding: 0;
  list-style-type: none;
}

// æ ·å¼ç”¨äºæ¯ä¸ªæœç´¢ç»“æœçš„æ–‡ç« 
.search-result--list article {
  display: flex;
  flex-direction: row;
  align-items: flex-start;
  padding: 16px;
  border-bottom: 1px solid #ddd;
  transition: background-color 0.3s ease;
  mark{
    background-color: lighten($color-accent, 20%);
    color: #fff;
  }
  &:hover {
    background-color: #f9f9f9;
  }
}

// æ ·å¼ç”¨äºæ–‡ç« çš„æ ‡é¢˜
.article-title {
  font-size: 1.5rem;
  margin: 0;
  color: #333;
  font-weight: bold;
  transition: color 0.3s ease;

  a {
    text-decoration: none;
    color: inherit;

    &:hover {
      color: #007bff;
    }
  }
}

// æ ·å¼ç”¨äºæ–‡ç« é¢„è§ˆéƒ¨åˆ†
.article-preview {
  font-size: 1rem;
  color: #666;
  margin-top: 8px;
  line-height: 1.5;
  body.night & {
    color: #e6e6e6;
  }

  mark {
    background-color: lighten($color-accent, 20%);
    color: #333;
    font-weight: bold;
  }
}


// æ ·å¼ç”¨äºæ–‡ç« çš„è¯¦ç»†ä¿¡æ¯éƒ¨åˆ†
.article-details {
  flex: 1;
}

// æ ·å¼ç”¨äºæœç´¢ç»“æœæ ‡é¢˜
.search-result--title {
  font-size: 1.25rem;
  margin-bottom: 16px;
  color: #555;
}
```

åŒæ ·ï¼Œä»£ç ä¸­ `$color-accent` ä»¥åŠ `body.night` ç›¸å…³ä»£ç æ˜¯ `Diary` ä¸»é¢˜ç‹¬æœ‰ï¼Œå…¶ä»–ä¸»é¢˜éœ€ä¿®æ”¹ã€‚

è‡³æ­¤æœç´¢é¡µé¢çš„æ·»åŠ å°±ç»“æŸäº†ã€‚

## å‚è€ƒ

- [Hugo Stack](https://github.com/CaiJimmy/hugo-theme-stack)
- [5åˆ†é’Ÿç»™Hugoåšå®¢å¢åŠ æœç´¢åŠŸèƒ½](https://ttys3.dev/blog/hugo-fast-search)

- [ç»™hugoæ·»åŠ æœç´¢åŠŸèƒ½](https://sobaigu.com/hugo-set-featuer-search.html)
