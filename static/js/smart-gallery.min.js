!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).SmartGallery=e()}(this,function(){"use strict";return class{constructor(t,e={}){if(this.container="string"==typeof t?document.querySelector(t):t,!this.container)throw new Error("SmartGallery: Container not found.");this.options=Object.assign({layout:"justified",gap:10,targetRowHeight:300,lastRowBehavior:"left",columnWidth:300,columns:"auto",className:"",itemClassName:"sg-item",virtualize:!0,buffer:500,placeholderColor:"#eee",renderItem:null,onItemClick:null},e),this.items=[],this.geometry=[],this.renderedIndices=new Set,this.resizeObserver=null,this.scrollHandler=null,this.isResizing=!1,this._init()}_init(){let t;this.container.style.position="relative",this.container.classList.add("smart-gallery"),this.options.className&&this.container.classList.add(this.options.className),this.resizeObserver=new ResizeObserver(()=>{this.isResizing||(clearTimeout(t),t=setTimeout(()=>{this.render()},100))}),this.resizeObserver.observe(this.container),this.options.virtualize&&(this.scrollHandler=this._throttle(this._handleScroll.bind(this),50),window.addEventListener("scroll",this.scrollHandler,{passive:!0}))}addItems(t){const e=t.map(t=>{let e=t.aspectRatio;return!e&&t.width&&t.height&&(e=t.width/t.height),e||(e=1),{...t,aspectRatio:e}});this.items=[...this.items,...e]}render(){if(!this.container||0===this.items.length)return;this.isResizing=!0;const t=this.container.clientWidth,{layout:e}=this.options;let i,s=0;this.renderedIndices.clear(),this.container.innerHTML="",this.geometry=[],"justified"===e?i=this._computeJustifiedLayout(this.items,t,this.options):"masonry"===e?i=this._computeMasonryLayout(this.items,t,this.options):"grid"===e&&(i=this._computeGridLayout(this.items,t,this.options)),this.geometry=i.boxes.map((t,e)=>({...t,itemIndex:e})),s=i.containerHeight,this.container.style.height=`${s}px`,this._updateVisibleItems(),this.isResizing=!1}_updateVisibleItems(){if(!this.options.virtualize)return void this._renderItems(this.geometry);const t=window.scrollY,e=window.innerHeight,i=this.options.buffer,s=this.container.getBoundingClientRect().top+t,o=Math.max(0,t-s-i),n=t-s+e+i,r=new Set;this.geometry.forEach(t=>{t.top+t.height>o&&t.top<n&&r.add(t.itemIndex)}),r.forEach(t=>{this.renderedIndices.has(t)||(this._mountItem(this.geometry[t]),this.renderedIndices.add(t))}),this.renderedIndices.forEach(t=>{r.has(t)||(this._unmountItem(t),this.renderedIndices.delete(t))})}_mountItem(t){const e=t.itemIndex,i=this.items[e],s=document.createElement("div");if(s.className=this.options.itemClassName,s.id=`sg-item-${e}`,s.style.position="absolute",s.style.left=`${t.left}px`,s.style.top=`${t.top}px`,s.style.width=`${t.width}px`,s.style.height=`${t.height}px`,this.options.renderItem)s.appendChild(this.options.renderItem(i,e));else{s.style.backgroundColor=i.placeholderColor||this.options.placeholderColor;const t=document.createElement("img");t.src=i.src,t.style.width="100%",t.style.height="100%",t.style.objectFit="cover",t.style.display="block",t.style.opacity="0",t.style.transition="opacity 0.3s",t.loading="lazy",t.onload=()=>{t.style.opacity="1"},s.appendChild(t)}s.addEventListener("click",t=>{this.options.onItemClick&&this.options.onItemClick({index:e,itemData:i,originalEvent:t})}),this.container.appendChild(s)}_unmountItem(t){const e=this.container.querySelector(`#sg-item-${t}`);e&&e.remove()}_handleScroll(){this.isResizing||requestAnimationFrame(()=>this._updateVisibleItems())}_throttle(t,e){let i;return function(){const s=arguments,o=this;i||(t.apply(o,s),i=!0,setTimeout(()=>i=!1,e))}}_computeJustifiedLayout(t,e,i){const{targetRowHeight:s,gap:o,lastRowBehavior:n}=i,r=[];let l=0;const h=.5*s,a=t.map(t=>t.aspectRatio);let c=0;for(;c<t.length;){let i=0,d=-1,m=0,u=1/0,p=c;for(;p<t.length;){i+=a[p];const t=(e-(p-c+1-1)*o)/i;if(t<h)break;const n=Math.abs(t-s);n<u&&(u=n,d=p,m=i),p++}if(-1!==d){let i=0;const h=m,u=(d-c+1-1)*o;i=(e-u)/h;let p=0;if(d===t.length-1){const t=n;if("hide"===t)break;if("left"===t||"center"===t||"right"===t){const o=(e-u)/h;i=Math.min(s,o);const n=h*i+u,r=Math.max(0,e-n);"center"===t?p=r/2:"right"===t&&(p=r)}}let g=p;for(let t=c;t<=d;t++){const e=i*a[t];r.push({left:g,top:l,width:e,height:i}),g+=e+o}l+=i+o,c=d+1}else{const t=Math.min(s,e/a[c]),i=t*a[c];r.push({left:0,top:l,width:i,height:t}),l+=t+o,c++}}return{boxes:r,containerHeight:l}}_getColumnMetrics(t,e){const{gap:i,columnWidth:s,columns:o}=e;let n=0,r=0;return"auto"===o?(r=s,n=Math.floor((t+i)/(r+i)),n=Math.max(1,n),r=(t-(n-1)*i)/n):(n=o,r=(t-(n-1)*i)/n),{gap:i,colCount:n,colW:r}}_computeMasonryLayout(t,e,i){const{gap:s,colCount:o,colW:n}=this._getColumnMetrics(e,i),r=new Array(o).fill(0),l=[];for(let e=0;e<t.length;e++){let i=0,h=r[0];for(let t=1;t<o;t++)r[t]<h&&(h=r[t],i=t);const a=n/t[e].aspectRatio;l.push({left:i*(n+s),top:h,width:n,height:a}),r[i]+=a+s}let h=r[0];for(let t=1;t<o;t++)r[t]>h&&(h=r[t]);return{boxes:l,containerHeight:h}}_computeGridLayout(t,e,i){const{gap:s,colCount:o,colW:n}=this._getColumnMetrics(e,i),r=n,l=[];for(let e=0;e<t.length;e++){const t=e%o,i=Math.floor(e/o);l.push({left:t*(n+s),top:i*(r+s),width:n,height:r})}return{boxes:l,containerHeight:Math.ceil(t.length/o)*(r+s)-s}}destroy(){this.resizeObserver&&this.resizeObserver.disconnect(),this.scrollHandler&&window.removeEventListener("scroll",this.scrollHandler)}}});
